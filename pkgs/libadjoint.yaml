extends: [cmake_package]
dependencies:
  build: [gccxml, mpi, petsc, slepc, {{build_with}}]

sources:
- key: tar.gz:ihznekfx5k5igxf7zhg65racz7npbcsn
  url: https://bitbucket.org/dolfin-adjoint/libadjoint/downloads/libadjoint-1.4.tar.gz

defaults:
  # lib/python2.7/site-packages/libadjoint/clibadjoint.py contains hard-coded path
  relocatable: false

build_stages:
- name: configure
  mode: override
  extra: ['-D CMAKE_CXX_COMPILER:FILEPATH=${MPICXX}',
          '-D CMAKE_C_COMPILER:FILEPATH=${MPICC}',
          '-D CMAKE_Fortran_COMPILER:FILEPATH=${MPIF90}']

# There is a bug when using -j option to make, so disable it for now.
- name: make
  mode: replace
  handler: bash
  after: configure
  bash: |
    make

- name: install
  mode: replace
  handler: bash
  after: make
  bash: |
    make install

when_build_dependency:
- prepend_path: PYTHONPATH
  value: '${ARTIFACT}/lib/python{{pyver}}/site-packages'
