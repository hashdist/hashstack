extends: [autotools_package]
dependencies:
  build: [mpi, zlib, szip]

sources:
- key: tar.bz2:7q253d6y2omn422slmt4yei4eh6hs6k2
  url: https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.8.17/src/hdf5-1.8.17.tar.bz2

defaults:
  # /bin/h5pcc contains hard-coded path
  relocatable: false

build_stages:
- name: set-cc-compiler
  after: prologue
  before: configure
  handler: bash
  bash: |
    export CC=${MPICC}

- when: machine == 'CrayXE6'
  name: make_exe_builds_static
  handler: bash
  after: configure
  before: make
  bash: |
    for f in {test,testpar,tools/*,perform,hl/*,hl/*/*}/Makefile
    do
      sed -i 's/CCLD = $(CC)/CCLD = $(CC) -static/g' $f
    done

- name: configure
  extra: ['--with-zlib=${ZLIB_DIR}',
          '--with-szlib=${SZIP_DIR}',
          '--with-pthread',
          '--enable-unsupported',
          '--enable-shared',
          '--enable-production=yes',
          '--enable-parallel=yes',
          '--enable-largefile=yes',
          '--with-default-api-version=v18']

- when: machine == 'CrayXE6'
  name: configure
  extra: ['--enable-static-exec',
          '--with-zlib=${ZLIB_DIR}',
          '--with-szlib=${SZIP_DIR}',
          '--with-pthread',
          '--enable-unsupported',
          '--enable-shared',
          '--enable-production=yes',
          '--enable-parallel=yes',
          '--enable-largefile=yes',
          '--with-default-api-version=v18',
          '--with-pic']


when_build_dependency:
- set: HDF5_ROOT
  value: '${ARTIFACT}'
- prepend_path: PATH
  value: '${ARTIFACT}/bin'
