extends: [base_package]

dependencies:
  # would be nice to have gnu-awk, perl, subversion and bzr as extra dependencies]
  build: [mercurial, git, {{build_with}}]
  run: [mercurial, git, {{build_with}}]

defaults:
  relocatable: false

sources:
- key: tar.gz:do3p32e472fzovviowxvlwmuztqjssdb
  url: http://golang.org/dl/go1.3.3.src.tar.gz

build_stages:
- name: make-install
  handler: bash
  bash: |
    # setup some target directories and 'install' go
    mkdir -p ${ARTIFACT}/go
    cp -a * ${ARTIFACT}/go

    # setup some environment variables that the go build system might expect
    # see http://golang.org/doc/install/source#environment
    export GOROOT=${ARTIFACT}/go
    export GOROOT_FINAL=${ARTIFACT}/go
    export GOBIN=${ARTIFACT}/go/bin

    # 'build' go
    cd ${ARTIFACT}/go/src
    bash all.bash

    # install documentation and coverage tools
    mkdir -p ${ARTIFACT}/gocode
    export GOPATH=${ARTIFACT}/gocode
    ${ARTIFACT}/go/bin/go get code.google.com/p/go.tools/cmd/godoc
    ${ARTIFACT}/go/bin/go get code.google.com/p/go.tools/cmd/vet

    # remove the object files generated by the compilation of go
    find ${ARTIFACT}/go/src -type f -name '*.[ao]' -delete

    # there isn't a good solution here, the user will need to export
    # GOBIN to their desired location or to ${ARTIFACT}/bin which
    # is the easiest thing to do, or else the developer will need
    # to decide on setting at least the GOPATH AND GOBIN
    mkdir -p ${ARTIFACT}/bin
    cp ${ARTIFACT}/go/bin/* ${ARTIFACT}/bin/

when_build_dependency:
- prepend_path: PATH
  value: '${ARTIFACT}/bin'
